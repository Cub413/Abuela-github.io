<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <style>
    html, body {
      margin: 0; padding: 0;
      overflow: hidden;
      background: #222;
      touch-action: none;
    }
    canvas {
      display: block;
      width: 100vw;
      height: 100vh;
    }
    #joystick {
      position: absolute; bottom: 30px; left: 30px;
      width: 100px; height: 100px; border-radius: 50%;
      background: rgba(255,255,255,0.1); border: 2px solid #888;
    }
    #stick {
      position: absolute; width: 40px; height: 40px;
      background: #ccc; border-radius: 50%;
      top: 30px; left: 30px;
    }
  #linterna {
  position: fixed;
  top: 0; left: 0;
  width: 100vw;
  height: 100vh;
  pointer-events: none;
  background: radial-gradient(circle at center, transparent 5px, rgba(0, 0, 0, 1) 100px);
  transition: background 0.3s ease;
}

  </style>
</head>
<body>
<canvas id="game"></canvas>
<div id="linterna"></div>

<div id="joystick"><div id="stick"></div></div>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

function resizeCanvas() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener("resize", resizeCanvas);
resizeCanvas();

let camX = 0, camY = 0;
let dead = false;
let fadeOut = 1;
let shake = 0;
let contactTime = 0;

const player = {
  x: 100,
  y: 100,
  w: 32,
  h: 32,
  speed: 2,
  flip: false,
  frame: 0,
  images: [new Image(), new Image()]
};
player.images[0].src = "pressets/player1.png";
player.images[1].src = "pressets/player2.png";

const enemy = {
  x: 300,
  y: 250,
  w: 40,
  h: 40,
  speed: 1.3,
  frame: 0,
  flip: false,
  images: [new Image(), new Image()],
  chasing: false,
  tick: 0,
  wanderAngle: 0
};
enemy.images[0].src = "pressets/enemigo1.jpg";
enemy.images[1].src = "pressets/enemigo2.jpg";

const walls = [
  { x: 0, y: 0, w: 800, h: 20, color: "#666" },
  { x: 0, y: 580, w: 800, h: 20, color: "#444" },
  { x: 0, y: 0, w: 20, h: 600, color: "#444" },
  { x: 780, y: 0, w: 20, h: 600, color: "#444" },
  { x: 200, y: 0, w: 20, h: 220, color: "#666" },
  { x: 400, y: 0, w: 20, h: 200, color: "#666" },
  { x: 0, y: 200, w: 150, h: 20, color: "#666" },
  { x: 100, y: 300, w: 600, h: 20, color: "#777" },
  { x: 300, y: 300, w: 20, h: 280, color: "#666" },
  { x: 500, y: 300, w: 20, h: 240, color: "#666" },
  { x: 200, y: 200, w: 200, h: 20, color: "#666" }
];

let vx = 0, vy = 0;
let tick = 0;

const stick = document.getElementById("stick");
let dragging = false, origin = {x: 0, y: 0};

document.getElementById("joystick").addEventListener("touchstart", e => {
  dragging = true;
  origin = {
    x: e.touches[0].clientX,
    y: e.touches[0].clientY
  };
});

document.getElementById("joystick").addEventListener("touchmove", e => {
  if (!dragging) return;
  const dx = e.touches[0].clientX - origin.x;
  const dy = e.touches[0].clientY - origin.y;
  const distance = Math.min(40, Math.hypot(dx, dy));
  const angle = Math.atan2(dy, dx);
  vx = Math.cos(angle) * (distance / 40) * player.speed;
  vy = Math.sin(angle) * (distance / 40) * player.speed;
  stick.style.left = 30 + Math.cos(angle) * distance + "px";
  stick.style.top = 30 + Math.sin(angle) * distance + "px";
  player.flip = vx < -0.5;
});

document.getElementById("joystick").addEventListener("touchend", () => {
  dragging = false;
  vx = vy = 0;
  stick.style.left = "30px";
  stick.style.top = "30px";
});

function checkCollisionRect(ax, ay, aw, ah, bx, by, bw, bh) {
  return ax < bx + bw && ax + aw > bx && ay < by + bh && ay + ah > by;
}

function checkCollision(x, y, w = player.w, h = player.h) {
  for (let wall of walls) {
    if (checkCollisionRect(x, y, w, h, wall.x, wall.y, wall.w, wall.h)) {
      return true;
    }
  }
  return false;
}

function distanceBetween(x1, y1, x2, y2) {
  return Math.hypot(x2 - x1, y2 - y1);
}

function moveEnemy() {
  const dist = distanceBetween(player.x, player.y, enemy.x, enemy.y);
  enemy.chasing = dist < 100;

  let dx = 0, dy = 0;

  if (enemy.chasing) {
    const angle = Math.atan2(player.y - enemy.y, player.x - enemy.x);
    dx = Math.cos(angle) * enemy.speed;
    dy = Math.sin(angle) * enemy.speed;
    enemy.flip = dx < -0.5;
  } else {
    if (enemy.tick % 90 === 0) {
      enemy.wanderAngle = Math.random() * Math.PI * 2;
    }
    dx = Math.cos(enemy.wanderAngle) * 0.6;
    dy = Math.sin(enemy.wanderAngle) * 0.6;
    enemy.flip = dx < -0.5;
  }

  const tryX = enemy.x + dx;
  const tryY = enemy.y + dy;
  if (!checkCollision(tryX, enemy.y, enemy.w, enemy.h)) enemy.x = tryX;
  if (!checkCollision(enemy.x, tryY, enemy.w, enemy.h)) enemy.y = tryY;

  enemy.tick++;
}

function loop() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  if (!dead) {
  const nextX = player.x + vx;
  const nextY = player.y + vy;
  if (!checkCollision(nextX, player.y)) player.x = nextX;
  if (!checkCollision(player.x, nextY)) player.y = nextY;
}

  camX = player.x + player.w/2 - canvas.width / 2;
  camY = player.y + player.h/2 - canvas.height / 2;

  tick++;
  if ((vx !== 0 || vy !== 0) && tick % 10 === 0) {
    player.frame = (player.frame + 1) % 2;
  }
  if (tick % 15 === 0) {
    enemy.frame = (enemy.frame + 1) % 2;
  }
if (!dead) {
  const touching = checkCollisionRect(player.x, player.y, player.w, player.h, enemy.x, enemy.y, enemy.w, enemy.h);
  if (touching) {
    contactTime += 1 / 60;
    if (contactTime >= 2) {
      dead = true;
      shake = 10;
      setTimeout(() => {
        resetGame();
      }, 000);
    }
  } else {
    contactTime = 0;
  }
}

  moveEnemy();

  ctx.save();
  ctx.translate(-camX, -camY);

  ctx.fillStyle = "#333";
  ctx.fillRect(-1000, -1000, 3000, 3000);

  for (let wall of walls) {
    ctx.fillStyle = wall.color;
    ctx.fillRect(wall.x, wall.y, wall.w, wall.h);
  }

// Jugador
ctx.save();
ctx.translate(player.x + player.w/2, player.y + player.h/2);

// Temblor al morir
if (dead && shake > 0) {
  ctx.translate((Math.random() - 0.5) * shake, (Math.random() - 0.5) * shake);
  shake *= 0.95; // va disminuyendo
}

if (player.flip) ctx.scale(-1, 1);
if (dead && fadeOut > 0) fadeOut -= 0.01;
ctx.globalAlpha = Math.max(0, fadeOut);
ctx.drawImage(player.images[player.frame], -player.w/2, -player.h/2, player.w, player.h);
ctx.restore();
ctx.globalAlpha = 1;

  // Enemigo
  ctx.save();
  ctx.translate(enemy.x + enemy.w/2, enemy.y + enemy.h/2);
  if (enemy.flip) ctx.scale(-1, 1);
  ctx.drawImage(enemy.images[enemy.frame], -enemy.w/2, -enemy.h/2, enemy.w, enemy.h);
  ctx.restore();

  ctx.restore();
  requestAnimationFrame(loop);
}

loop();
function resetGame() {
  player.x = 100;
  player.y = 100;
  enemy.x = 300;
  enemy.y = 250;
  fadeOut = 1;
  dead = false;
  contactTime = 0;
  shake = 0;
  vx = 0;
  vy = 0;
  stick.style.left = "30px";
  stick.style.top = "30px";
}

</script>
</body>
</html>
