<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    html, body {
      margin: 0; padding: 0;
      overflow: hidden;
      background: #222;
      touch-action: none;
      
    }
    canvas {
      display: block;
      width: 100vw;
      height: 100vh;
    }
#joystick {
  position: absolute; bottom: 30px; left: 30px;
  width: 100px; height: 100px;
  background: rgba(255, 255, 255, 0.1);
  border: 2px solid #888;
  image-rendering: pixelated;
}

#stick {
  position: absolute;
  width: 40px; height: 40px;
  background: #ccc;
  top: 30px; left: 30px;
  image-rendering: pixelated;
  /* Sin border-radius para esquinas cuadradas */
  /* Puedes agregar un borde grueso estilo 8-bit */
  border: 2px solid #666;
  box-sizing: border-box;
}

#linterna {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  pointer-events: none;
  background: radial-gradient(circle at center, transparent 15px, rgba(0, 0, 0, 1) 300px);
  animation: linternaPulse 3s ease-in-out infinite;
}

@keyframes linternaPulse {
  0%, 100% {
    background: radial-gradient(circle at center, transparent 15px, rgba(0, 0, 0, 1) 300px);
  }
  50% {
    background: radial-gradient(circle at center, transparent 25px, rgba(0, 0, 0, 1) 320px);
  }
}

    /* Estilos pantalla de muerte */
   #deathScreen {
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(15, 0, 0, 0.95);
  z-index: 9999;
  justify-content: center;
  align-items: center;
  flex-direction: column;
  display: flex;
  filter: drop-shadow(0 0 10px crimson);
  animation: pulsarRojo 2s infinite alternate;
}

@keyframes pulsarRojo {
  0% { background-color: rgba(15, 0, 0, 0.85); }
  100% { background-color: rgba(40, 0, 0, 1); }
}

#deathContent {
  background: linear-gradient(90deg, #330000, #660000);
  padding: 40px 50px;
  border-radius: 12px;
  text-align: center;
  box-shadow: 0 0 40px 5px crimson;
  border: 4px solid #8B0000;
  position: relative;
  overflow: hidden;
}

#deathContent::before {
  content: "";
  position: absolute;
  top: -10px; left: -10px; right: -10px; bottom: -10px;
  border: 3px dashed crimson;
  border-radius: 12px;
  pointer-events: none;
  animation: sangrar 1.5s infinite;
}

@keyframes sangrar {
  0%, 100% { border-color: crimson; }
  50% { border-color: darkred; }
}

#deathContent h1 {
  color: #FF1A1A;
  font-family: 'Creepster', cursive, monospace;
  margin-bottom: 30px;
  font-size: 36px;
  text-shadow: 0 0 15px crimson, 0 0 20px red;
  letter-spacing: 3px;
  animation: parpadeoTitulo 2s infinite ease-in-out;
}

@keyframes parpadeoTitulo {
  0%, 100% {
    color: #FF1A1A;
    text-shadow: 0 0 15px crimson, 0 0 20px red;
    opacity: 1;
  }
  50% {
    color: #FF4D4D;
    text-shadow: 0 0 30px crimson, 0 0 40px red;
    opacity: 0.7;
  }
  75% {
    color: #FF0000;
    text-shadow: 0 0 25px crimson, 0 0 35px red;
    opacity: 0.85;
  }
}

#deathContent button {
  margin: 15px;
  padding: 14px 30px;
  font-family: 'Press Start 2P', monospace;
  font-size: 18px;
  border: 2px solid #FF0000;
  border-radius: 6px;
  background: linear-gradient(135deg, #990000, #FF0000);
  color: #fff;
  cursor: pointer;
  box-shadow: 0 0 10px crimson;
  transition: background 0.3s, box-shadow 0.3s;
}

#deathContent button:hover {
  background: linear-gradient(135deg, #FF0000, #660000);
  box-shadow: 0 0 20px crimson;
}
#deathContent button.parpadeante {
  animation-name: parpadeoLuz;
  animation-iteration-count: infinite;
  animation-timing-function: ease-in-out;
}

#deathContent button.delay1 {
  animation-duration: 1.2s;
  animation-delay: 0s;
}

#deathContent button.delay2 {
  animation-duration: 1.2s;
  animation-delay: 0.6s; /* medio ciclo desfasado */
}

@keyframes parpadeoLuz {
  0%, 100% { opacity: 1; }
  10%, 30%, 50%, 70%, 90% { opacity: 0.3; }
  20%, 40%, 60%, 80% { opacity: 0.8; }
}
#startScreen {
  position: fixed;
  top: 0; left: 0;
  width: 100vw; height: 100vh;
  backdrop-filter: blur(6px);
  background: rgba(0, 0, 0, 0.8);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  animation: flickerBG 2s infinite;
}

#startBtn {
  font-family: 'Press Start 2P', monospace;
  font-size: 20px;
  padding: 20px 40px;
  background: #8b0000;
  color: #fff;
  border: 4px solid #fff;
  box-shadow: 0 0 15px crimson, 0 0 30px red;
  cursor: pointer;
  animation: flickerBtn 1.8s infinite alternate;
  text-shadow: 0 0 4px #fff, 0 0 6px red;
}

@keyframes flickerBtn {
  0% { opacity: 0.8; transform: scale(1); }
  50% { opacity: 0.3; transform: scale(1.05); }
  100% { opacity: 1; transform: scale(1); }
}

@keyframes flickerBG {
  0%, 100% { background-color: rgba(0, 0, 0, 0.8); }
  50% { background-color: rgba(0, 0, 0, 0.7); }
}

  </style>
</head>
<body>
  <div id="startScreen">
  <button id="startBtn" onclick="startGame()">START</button>
</div>

<canvas id="game"></canvas>
<div id="linterna"></div>

<div id="joystick"><div id="stick"></div></div>

<!-- Pantalla de muerte -->
<div id="deathScreen">
  <div id="deathContent">
    <h1>Has muerto</h1>
<button class="parpadeante delay1" onclick="resetGame()">Reintentar</button>
<button class="parpadeante delay2" onclick="window.location.href='inicio.html'">Rendirse</button>

  </div>
</div>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

function resizeCanvas() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener("resize", resizeCanvas);
resizeCanvas();

let camX = 0, camY = 0;
let dead = false;
let fadeOut = 1;
let shake = 0;
let contactTime = 0;

const player = {
  x: 100,
  y: 100,
  w: 100,
  h: 100,
  speed: 2,
  flip: false,
  frame: 0,
  images: [new Image(), new Image()]
};
player.images[0].src = "pressets/player1.png";
player.images[1].src = "pressets/player2.png";

const enemy = {
  x: 900,
  y: 750,
  w: 120,
  h: 120,
  speed: 1.95,
  frame: 0,
  flip: false,
  images: [new Image(), new Image()],
  chasing: false,
  tick: 0,
  wanderAngle: 0
};
function startGame() {
  const screen = document.documentElement;
  if (screen.requestFullscreen) {
    screen.requestFullscreen();
  } else if (screen.webkitRequestFullscreen) {
    screen.webkitRequestFullscreen();
  } else if (screen.msRequestFullscreen) {
    screen.msRequestFullscreen();
  }

  document.getElementById('startScreen').style.display = 'none';
  // Aquí puedes poner otras funciones que inicialicen el juego
}

enemy.images[0].src = "pressets/enemigo1.jpg";
enemy.images[1].src = "pressets/enemigo2.jpg";

const walls = [
  { x: 0, y: 0, w: 2400, h: 60, color: "#777" },
  { x: 0, y: 1740, w: 2400, h: 60, color: "#777" },
  { x: 0, y: 0, w: 60, h: 1800, color: "#777" },
  { x: 2340, y: 0, w: 60, h: 1800, color: "#777" },
  { x: 600, y: 0, w: 60, h: 450, color: "#777" },
  { x: 1200, y: 0, w: 60, h: 600, color: "#777" },
  { x: 0, y: 600, w: 450, h: 60, color: "#777" },
  { x: 300, y: 900, w: 1800, h: 60, color: "#777" },
  { x: 900, y: 900, w: 60, h: 840, color: "#777" },
  { x: 1500, y: 900, w: 60, h: 690, color: "#777" },
  { x: 600, y: 600, w: 600, h: 60, color: "#777" }
];

let objetos = [];

// Crear cinco texturas diferentes
let texturasObjetos = [
  new Image(), new Image(), new Image(), new Image(), new Image()
];

texturasObjetos[0].src = "pressets/cama.png";
texturasObjetos[1].src = "pressets/armario.png";
texturasObjetos[2].src = "pressets/otroarmario.png";
texturasObjetos[3].src = "pressets/mesa.png";
texturasObjetos[4].src = "pressets/armario.png";
const texturasPL = {
  llave: new Image(),
  puerta: new Image(),
  puertaAbierta: new Image()
};
texturasPL.llave.src = "pressets/llave.png";
texturasPL.puerta.src = "pressets/puerta.jpg";
texturasPL.puertaAbierta.src = "pressets/puertacerrada.png";

const puertayllave = [
  { x: 750, y: 1650, w: 60, h: 75, tipo: "llave", recogida: false }, // llave escalada ×3
  { x: 600, y: 660, w: 225, h: 240, tipo: "puerta", abierta: false } // puerta escalada ×1.5
];


let tieneLlavePL = false;
const iconoSonido = new Image();
iconoSonido.src = "pressets/sonido.png";
const distanciaIconoSonido = 450; // Ajusta este valor para más o menos alcance

objetos.push({ x: 60, y: 450, w: 120, h: 150, textura: texturasObjetos[0] });
objetos.push({ x: 660, y: 60, w: 120, h: 180, textura: texturasObjetos[1] });
objetos.push({ x: 720, y: 960, w: 180, h: 240, textura: texturasObjetos[2] });
objetos.push({ x: 1500, y: 300, w: 150, h: 150, textura: texturasObjetos[3] });
objetos.push({ x: 951, y: 1500, w: 180, h: 240, textura: texturasObjetos[4] });

const texturasExtra = {
  llave2: new Image(),
  llave3: new Image(),
  puerta2: new Image(),
  puerta3: new Image(),
  puertaAbierta: new Image()
};

texturasExtra.llave2.src = "pressets/llave.png";
texturasExtra.llave3.src = "pressets/llave.png";
texturasExtra.puerta2.src = "pressets/puerta.jpg";
texturasExtra.puerta3.src = "pressets/puerta.jpg";
texturasExtra.puertaAbierta.src = "pressets/puertacerrada.png";

const llavesExtras = [
  { x: 1800, y: 90, w: 60, h: 60, recogida: false, id: "llave2" },
  { x: 1650, y: 1060, w: 60, h: 60, recogida: false, id: "llave3" }
];

const puertasExtras = [
  { x: 2100, y: 900, w: 240, h: 60, abierta: false, id: "puerta2", llave: "llave2" },
  { x: 1500, y: 1590, w: 60, h: 150, abierta: false, id: "puerta3", llave: "llave3" }
];

// Este código va en cada nivel
localStorage.setItem('lastLevel', 'lvl1.html'); // Reemplazá por el nivel correspondiente

let llavesObtenidas = {
  llave2: false,
  llave3: false,
};

let vx = 0, vy = 0;
let tick = 0;
const playerStepSound = new Audio('pressets/pasos.mp3');
playerStepSound.loop = true;
playerStepSound.volume = 0;
playerStepSound.playbackRate = 1.8;

const enemyStepSound = new Audio('pressets/pasos.mp3');
enemyStepSound.loop = true;
enemyStepSound.volume = 0;
enemyStepSound.playbackRate = 1.8;
const ambientSound = new Audio('pressets/ambiental.mp3');
ambientSound.loop = true;
ambientSound.volume = 0.5;

const stick = document.getElementById("stick");
let dragging = false, origin = {x: 0, y: 0};

document.getElementById("joystick").addEventListener("touchstart", e => {
  dragging = true;
  origin = {
    x: e.touches[0].clientX,
    y: e.touches[0].clientY
  };
});

document.getElementById("joystick").addEventListener("touchmove", e => {
  if (!dragging) return;
  const dx = e.touches[0].clientX - origin.x;
  const dy = e.touches[0].clientY - origin.y;
  const distance = Math.min(40, Math.hypot(dx, dy));
  const angle = Math.atan2(dy, dx);
  vx = Math.cos(angle) * (distance / 40) * player.speed;
  vy = Math.sin(angle) * (distance / 40) * player.speed;
  stick.style.left = 30 + Math.cos(angle) * distance + "px";
  stick.style.top = 30 + Math.sin(angle) * distance + "px";
  player.flip = vx < -0.5;
});

document.getElementById("joystick").addEventListener("touchend", () => {
  dragging = false;
  vx = vy = 0;
  stick.style.left = "30px";
  stick.style.top = "30px";
});
function colisionPL(a, b) {
  return !(a.x + a.w <= b.x || a.x >= b.x + b.w || a.y + a.h <= b.y || a.y >= b.y + b.h);
}

function checkCollisionRect(ax, ay, aw, ah, bx, by, bw, bh) {
  return ax < bx + bw && ax + aw > bx && ay < by + bh && ay + ah > by;
}

function checkCollision(x, y, w = player.w, h = player.h) {
  for (let wall of walls) {
    if (checkCollisionRect(x, y, w, h, wall.x, wall.y, wall.w, wall.h)) {
      return true;
    }
  }
  for (let obj of puertayllave) {
  if (obj.tipo === "puerta" && !obj.abierta) {
    if (checkCollisionRect(x, y, w, h, obj.x, obj.y, obj.w, obj.h)) {
      return true;
    }
  }
}
for (let puerta of puertasExtras) {
  if (!puerta.abierta && checkCollisionRect(x, y, w, h, puerta.x, puerta.y, puerta.w, puerta.h)) {
    return true;
  }
}

  for (let obj of objetos) {
    if (checkCollisionRect(x, y, w, h, obj.x, obj.y, obj.w, obj.h)) {
      return true;
    }
  }
  return false;
}
function colisionPL(a, b) {
  return !(a.x + a.w <= b.x || a.x >= b.x + b.w || a.y + a.h <= b.y || a.y >= b.y + b.h);
}

function distanceBetween(x1, y1, x2, y2) {
  return Math.hypot(x2 - x1, y2 - y1);
}

function moveEnemy() {
  const dist = distanceBetween(player.x, player.y, enemy.x, enemy.y);
  enemy.chasing = dist < 300;

  let dx = 0, dy = 0;

  if (enemy.chasing) {
    const angle = Math.atan2(player.y - enemy.y, player.x - enemy.x);
    dx = Math.cos(angle) * enemy.speed;
    dy = Math.sin(angle) * enemy.speed;
    enemy.flip = dx < -0.5;
  } else {
    if (enemy.tick % 90 === 0) {
      enemy.wanderAngle = Math.random() * Math.PI * 2;
    }
    dx = Math.cos(enemy.wanderAngle) * 0.6;
    dy = Math.sin(enemy.wanderAngle) * 0.6;
    enemy.flip = dx < -0.5;
  }

  const tryX = enemy.x + dx;
  const tryY = enemy.y + dy;
  if (!checkCollision(tryX, enemy.y, enemy.w, enemy.h)) enemy.x = tryX;
  if (!checkCollision(enemy.x, tryY, enemy.w, enemy.h)) enemy.y = tryY;

  enemy.tick++;
}
joystick.addEventListener("touchstart", (e) => {
  dragging = true;
for (let puerta of puertasExtras) {
  if (!puerta.abierta && checkCollisionRect(x, y, w, h, puerta.x, puerta.y, puerta.w, puerta.h)) {
    return true;
  }
}

  // Iniciar sonido ambiental al primer toque
  if (ambientSound.paused) {
    ambientSound.play().catch(() => {});
  }
}, { passive: false });

function loop() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  const prevX = player.x;
  const prevY = player.y;

  // Mover en X
  player.x += vx;

  let colisionX = false;

  for (let wall of walls) {
    if (colisionPL(player, wall)) {
      colisionX = true;
      break;
    }
  }

  for (let obj of objetos) {
    if (colisionPL(player, obj)) {
      colisionX = true;
      break;
    }
  }

  // Colisión con puertasExtras cerradas
  for (let puerta of puertasExtras) {
    if (!puerta.abierta && colisionPL(player, puerta)) {
      if (llavesObtenidas[puerta.llave]) {
        puerta.abierta = true;
      } else {
        colisionX = true;
      }
    }
  }

  // Colisión con puerta original
  for (let obj of puertayllave) {
    if (obj.tipo === "puerta" && !obj.abierta && colisionPL(player, obj)) {
      if (tieneLlavePL) {
        obj.abierta = true;
      } else {
        colisionX = true;
      }
    }
  }

  if (colisionX) {
    player.x = prevX;
    vx = 0;
  }

  // Mover en Y
  player.y += vy;

  let colisionY = false;

  for (let wall of walls) {
    if (colisionPL(player, wall)) {
      colisionY = true;
      break;
    }
  }

  for (let obj of objetos) {
    if (colisionPL(player, obj)) {
      colisionY = true;
      break;
    }
  }

  // Colisión con puertasExtras cerradas
  for (let puerta of puertasExtras) {
    if (!puerta.abierta && colisionPL(player, puerta)) {
      if (llavesObtenidas[puerta.llave]) {
        puerta.abierta = true;
      } else {
        colisionY = true;
      }
    }
  }

  // Colisión con puerta original
  for (let obj of puertayllave) {
    if (obj.tipo === "puerta" && !obj.abierta && colisionPL(player, obj)) {
      if (tieneLlavePL) {
        obj.abierta = true;
      } else {
        colisionY = true;
      }
    }
  }

  if (colisionY) {
    player.y = prevY;
    vy = 0;
  }

  // Recoger llaves nuevas
  for (let llave of llavesExtras) {
    if (!llave.recogida && colisionPL(player, llave)) {
      llave.recogida = true;
      llavesObtenidas[llave.id] = true;
    }
  }

  // Recoger llave original
  for (let obj of puertayllave) {
    if (obj.tipo === "llave" && !obj.recogida && colisionPL(player, obj)) {
      obj.recogida = true;
      tieneLlavePL = true;
    }
  }

  if (!dead) {
    const nextX = player.x + vx;
    const nextY = player.y + vy;
    if (!checkCollision(nextX, player.y)) player.x = nextX;
    if (!checkCollision(player.x, nextY)) player.y = nextY;
  }

  // Sonido de pasos del jugador con volumen por velocidad
  const playerSpeed = Math.hypot(vx, vy);

const maxSpeed = player.speed;
const playerVolume = Math.min(1, playerSpeed / maxSpeed);

playerStepSound.volume = playerVolume;

if (playerVolume > 0.05) {
  if (playerStepSound.paused) playerStepSound.play();
} else {
  if (!playerStepSound.paused) playerStepSound.pause();
}

  camX = player.x + player.w/2 - canvas.width / 2;
  camY = player.y + player.h/2 - canvas.height / 2;

  tick++;
  if ((vx !== 0 || vy !== 0) && tick % 10 === 0) {
    player.frame = (player.frame + 1) % 2;
  }
  if (tick % 15 === 0) {
    enemy.frame = (enemy.frame + 1) % 2;
  }

  if (!dead) {
    
    const touching = checkCollisionRect(player.x, player.y, player.w, player.h, enemy.x, enemy.y, enemy.w, enemy.h);
    if (touching) {
      contactTime += 1 / 60;
      if (contactTime >= 2) {
        dead = true;
        shake = 10;
        document.getElementById("deathScreen").style.display = "flex";
      }
    } else {
      contactTime = 0;
    }
  }

  moveEnemy();
// Sonido del enemigo con atenuación por distancia
const distToPlayer = distanceBetween(player.x, player.y, enemy.x, enemy.y);
const maxDist = 3000;
const vol = Math.max(0, 1 - distToPlayer / maxDist);
enemyStepSound.volume = vol;

if (enemy.chasing && vol > 0.05) {
  if (enemyStepSound.paused) enemyStepSound.play();
} else {
  if (!enemyStepSound.paused) enemyStepSound.pause();
}

  ctx.save();
  ctx.translate(-camX, -camY);

  ctx.fillStyle = "#333";
  ctx.fillRect(-1000, -1000, 3000, 3000);

  for (let wall of walls) {
    ctx.fillStyle = wall.color;
    ctx.fillRect(wall.x, wall.y, wall.w, wall.h);
  }

  // Objetos
  for (let obj of objetos) {
    ctx.drawImage(obj.textura, obj.x, obj.y, obj.w, obj.h);
  }
for (let llave of llavesExtras) {
  if (!llave.recogida) {
    const img = llave.id === "llave2" ? texturasExtra.llave2 : texturasExtra.llave3;
    ctx.drawImage(img, llave.x, llave.y, llave.w, llave.h);
  }
}

for (let puerta of puertasExtras) {
  const img = puerta.abierta ? texturasExtra.puertaAbierta :
              puerta.id === "puerta2" ? texturasExtra.puerta2 : texturasExtra.puerta3;
  ctx.drawImage(img, puerta.x, puerta.y, puerta.w, puerta.h);
}

  // Jugador
  ctx.save();
  ctx.translate(player.x + player.w/2, player.y + player.h/2);

  // Temblor al morir
  if (dead && shake > 0) {
    ctx.translate((Math.random() - 0.5) * shake, (Math.random() - 0.5) * shake);
    shake *= 0.95; // va disminuyendo
  }

  if (player.flip) ctx.scale(-1, 1);
  if (dead && fadeOut > 0) fadeOut -= 0.01;
  ctx.globalAlpha = Math.max(0, fadeOut);
  ctx.drawImage(player.images[player.frame], -player.w/2, -player.h/2, player.w, player.h);
  ctx.restore();
  ctx.globalAlpha = 1;
for (let obj of puertayllave) {
  if (obj.tipo === "llave" && obj.recogida) continue;

  let img = obj.tipo === "llave"
    ? texturasPL.llave
    : (obj.abierta ? texturasPL.puertaAbierta : texturasPL.puerta);

  if (img && img.complete) {
    ctx.drawImage(img, obj.x, obj.y, obj.w, obj.h);
  }
}
const dxIcono = enemy.x + enemy.w / 2 - (player.x + player.w / 2);
const dyIcono = enemy.y + enemy.h / 2 - (player.y + player.h / 2);
const distancia = Math.hypot(dxIcono, dyIcono);

if (distancia < distanciaIconoSonido) {
  const angulo = Math.atan2(dyIcono, dxIcono);
  const radio = 100; // Distancia del icono alrededor del jugador, ajustado al tamaño jugador

  const iconoX = player.x + player.w / 2 + Math.cos(angulo) * radio;
  const iconoY = player.y + player.h / 2 + Math.sin(angulo) * radio;

  ctx.save();
  ctx.translate(iconoX, iconoY);
  ctx.rotate(angulo - Math.PI / 2);
  ctx.drawImage(iconoSonido, -32, -32, 64, 64); // Tamaño icono 64x64 centrado en el punto
  ctx.restore();
}

  // Enemigo
  ctx.save();
  ctx.translate(enemy.x + enemy.w/2, enemy.y + enemy.h/2);
  if (enemy.flip) ctx.scale(-1, 1);
  ctx.drawImage(enemy.images[enemy.frame], -enemy.w/2, -enemy.h/2, enemy.w, enemy.h);
  ctx.restore();

  ctx.restore();
  requestAnimationFrame(loop);
}

loop();

function resetGame() {
  player.x = 100;
  player.y = 100;
  enemy.x = 300;
  enemy.y = 250;
  fadeOut = 1;
  dead = false;
  contactTime = 0;
  shake = 0;
  vx = 0;
  vy = 0;
  stick.style.left = "30px";
  stick.style.top = "30px";

  document.getElementById("deathScreen").style.display = "none";
}
document.getElementById("deathScreen").style.display = "none";

</script>
</body>
</html>
